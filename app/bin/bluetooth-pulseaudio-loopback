#!/bin/bash
RUN_AS=sonos
audio_sink=0
name=$(sed 's/\"//g' <<< $NAME)
#exit if not a BT address
if [[ ! $name =~ ^([0-9A-F]{2}[:-]){5}([0-9A-F]{2})$ ]]; then exit 0;  fi

audio_source=bluez_source.$(sed 's/:/_/g' <<< $name)

action=$(expr "$ACTION" : "\([a-zA-Z]\+\).*")
if [ "$action" = "add" ]; then
  logger "[$(basename $0)] Bluetooth device is being added [$name]"
  logger "[$(basename $0)] Patching $audio_source into ALSA sink #$audio_sink"

  handle=$(su -c "pactl load-module module-loopback source=$audio_source sink=$audio_sink" $RUN_AS)
  logger "[$(basename $0)] PulseAudio module-loopback returned handle [$handle]"
fi

if [ "$action" = "remove" ]; then
  logger "[$(basename $0)] Bluetooth device is being removed [$name]"
  for handle in $(su -c "pactl list short modules | grep module-loopback | grep source=$audio_source | cut -f 1" $RUN_AS); do
    logger "[$(basename $0)] Unloading module-loopback with handle [$handle]"
    su -c "pactl unload-module $handle" $RUN_AS
  done
fi
